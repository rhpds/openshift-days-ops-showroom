= AWS WAF Integration

== Module Overview

**Duration:** 15 minutes +
**Format:** Educational overview (no hands-on) +
**Audience:** Platform Engineers, Security Teams, Network Administrators

[IMPORTANT]
====
**This module is informational only.**

Since this workshop environment is not running on AWS, you will not be executing the commands in this module. Instead, we'll explain how AWS WAF integrates with OpenShift so you understand the architecture and benefits for when you deploy on AWS infrastructure.

The code examples shown are for **reference only** - do not run them in this environment.
====

**Narrative Context:**

When running OpenShift on AWS, you can leverage **AWS WAF** (Web Application Firewall) for advanced threat protection against OWASP Top 10 vulnerabilities including SQL injection, cross-site scripting (XSS), and other common web attacks.

== Learning Objectives

By the end of this module, you will understand:

* How AWS WAF integrates with OpenShift architecture
* The role of the AWS Load Balancer Operator
* How Application Load Balancers (ALBs) work with WAF
* Available WAF rule sets for common attack protection
* When to use AWS WAF vs built-in OpenShift security features

== AWS WAF Architecture

When OpenShift runs on AWS, you can integrate with **AWS WAF** for advanced threat protection. AWS WAF attaches to an Application Load Balancer (ALB), which sits in front of your OpenShift workloads:

----
Internet → AWS ALB + WAF → OpenShift Ingress → Service → Pods
----

**Key insight:** WAF inspection happens at the AWS edge, before traffic even reaches your OpenShift cluster. This provides defense-in-depth and offloads security processing from your cluster.

=== When to Use What

[cols="1,2,2"]
|===
|Scenario |Solution |Notes

|Basic rate limiting
|Route annotations
|Built-in to OpenShift, no extra cost

|IP-based blocking
|Route annotations or NetworkPolicy
|Built-in to OpenShift

|OWASP protection (SQLi, XSS)
|AWS WAF + ALB
|Requires ALB, additional AWS cost

|DDoS protection
|AWS Shield + CloudFront
|Enterprise AWS feature

|API security
|3scale API Management
|Full API gateway with policies
|===

== Component Overview

=== AWS Load Balancer Operator

The **AWS Load Balancer Operator** is a Red Hat-supported operator that manages AWS Application Load Balancers (ALBs) and Network Load Balancers (NLBs) for OpenShift workloads.

**What it does:**

* Watches for Ingress resources with `ingressClassName: alb`
* Automatically provisions AWS ALBs
* Configures target groups pointing to your services
* Manages ALB lifecycle (create, update, delete)
* Integrates with AWS WAF via annotations

**Installation (reference):**

[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: aws-load-balancer-operator
  namespace: openshift-operators
spec:
  channel: stable-v1
  name: aws-load-balancer-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
----

=== AWSLoadBalancerController

After the operator is installed, you create an `AWSLoadBalancerController` resource to configure its behavior:

[source,yaml]
----
apiVersion: networking.olm.openshift.io/v1
kind: AWSLoadBalancerController
metadata:
  name: cluster
spec:
  subnetTagging: Auto
  ingressClass: alb
  enabledAddons:
    - AWSWAFv2  # Enables WAF integration
----

**Key configuration:**

* `subnetTagging: Auto` - Automatically discovers and tags subnets
* `ingressClass: alb` - Defines the ingress class name
* `enabledAddons: [AWSWAFv2]` - Enables WAF integration capability

=== ALB-backed Ingress

To provision an ALB for your application, create an Ingress with the `alb` ingress class:

[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-alb
  namespace: myapp
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
spec:
  ingressClassName: alb
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp
            port:
              number: 8080
----

**What happens:**

1. AWS Load Balancer Operator detects the Ingress
2. Creates an ALB in your AWS account
3. Configures listeners and target groups
4. Routes traffic to your OpenShift service

== AWS WAF Configuration

=== WAF WebACL

A **Web Access Control List (WebACL)** defines the rules that inspect and filter web requests. AWS provides managed rule sets for common threats:

**AWS Managed Rule Sets:**

[cols="1,3"]
|===
|Rule Set |Protection

|**AWSManagedRulesCommonRuleSet**
|Cross-site scripting (XSS), path traversal, local file inclusion, PHP/Java exploits

|**AWSManagedRulesSQLiRuleSet**
|SQL injection attacks

|**AWSManagedRulesKnownBadInputsRuleSet**
|Known malicious inputs (Log4j, etc.)

|**AWSManagedRulesLinuxRuleSet**
|Linux-specific exploits

|**AWSManagedRulesUnixRuleSet**
|POSIX/Unix exploits
|===

**Example WebACL creation (AWS CLI reference):**

[source,bash]
----
aws wafv2 create-web-acl \
  --name openshift-waf \
  --scope REGIONAL \
  --default-action Allow={} \
  --visibility-config SampledRequestsEnabled=true,CloudWatchMetricsEnabled=true,MetricName=openshift-waf \
  --rules '[
    {
      "Name": "CommonRuleSet",
      "Priority": 1,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesCommonRuleSet"
        }
      },
      "OverrideAction": {"None": {}},
      "VisibilityConfig": {...}
    }
  ]'
----

=== Associating WAF with ALB

Once the WebACL exists, associate it with your ALB using an Ingress annotation:

[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-alb
  annotations:
    alb.ingress.kubernetes.io/wafv2-acl-arn: "arn:aws:wafv2:us-east-2:123456789:regional/webacl/openshift-waf/abc123"
spec:
  ingressClassName: alb
  # ... rest of ingress spec
----

The AWS Load Balancer Operator automatically associates the WAF with the ALB.

== How WAF Protection Works

When a request arrives at your ALB with WAF enabled:

1. **Request received** - Client sends HTTP request to ALB
2. **WAF inspection** - AWS WAF evaluates request against all rules
3. **Rule matching** - Each rule checks for specific attack patterns
4. **Action taken** - Block (403), Allow, or Count (log only)
5. **Forwarding** - If allowed, request proceeds to OpenShift

**Example attack flow:**

----
Attacker: GET /app?id=1' OR '1'='1

1. Request hits ALB
2. WAF SQLi rule detects pattern
3. Request blocked with 403 Forbidden
4. Attack never reaches OpenShift pods
----

== Monitoring and Visibility

AWS WAF provides visibility through:

* **CloudWatch Metrics** - BlockedRequests, AllowedRequests, CountedRequests
* **WAF Logs** - Full request details for blocked/sampled requests (to S3, CloudWatch, or Kinesis)
* **AWS Console** - Real-time dashboard of WAF activity

**Benefits for operations:**

* See attack patterns and sources
* Tune rules based on false positives
* Demonstrate compliance (audit logs)
* Alert on unusual activity

== Cost Considerations

AWS WAF pricing (as of 2024):

* **WebACL:** $5/month per WebACL
* **Rules:** $1/month per rule
* **Requests:** $0.60 per million requests inspected

**Example monthly cost for typical workload:**

* 1 WebACL with 5 managed rule groups
* 10 million requests/month
* Cost: ~$5 + $5 + $6 = **$16/month**

Compare this to the cost of a security breach - WAF is typically very cost-effective.

== Summary

**Key takeaways:**

* AWS WAF provides OWASP protection (SQL injection, XSS, etc.) at the AWS edge
* The AWS Load Balancer Operator manages ALBs that integrate with WAF
* WAF rules are evaluated before traffic reaches your OpenShift cluster
* Managed rule sets provide protection without writing custom rules
* CloudWatch provides visibility into blocked attacks

**When to use AWS WAF:**

* Running OpenShift on AWS (ROSA, self-managed on AWS)
* Need OWASP Top 10 protection beyond rate limiting
* Compliance requirements for web application security
* Want to offload security processing from the cluster

**Alternatives for non-AWS environments:**

* **OpenShift Service Mesh** with Envoy filters
* **Third-party WAFs** (F5, Cloudflare, Imperva)
* **Red Hat 3scale** for API-level protection
* **Network policies** for basic traffic control

== Additional Resources

* **AWS Load Balancer Operator:** link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.20/html/networking/aws-load-balancer-operator[AWS Load Balancer Operator Documentation]
* **AWS WAF Developer Guide:** link:https://docs.aws.amazon.com/waf/latest/developerguide/[AWS WAF Documentation]
* **AWS Managed Rules:** link:https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups-list.html[AWS Managed Rule Groups List]
* **OWASP Top 10:** link:https://owasp.org/www-project-top-ten/[OWASP Top 10 Web Application Security Risks]
