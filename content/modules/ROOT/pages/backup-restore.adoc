= Backup & Restore with OADP

== Module Overview

**Duration:** 20 minutes +
**Format:** Hands-on backup and restore operations +
**Audience:** Platform Engineers, Operations Teams

Data protection is critical for production OpenShift clusters. In this module, you'll use **OADP (OpenShift API for Data Protection)** to backup a running application, simulate a disaster by deleting it, and restore it from backup.

== Learning Objectives

* Create application backups
* Restore applications from backups
* Implement backup schedules
* Understand the backup/restore workflow

== Verify OADP is Ready

OADP and its backup storage have been pre-configured. Verify everything is working:

[source,bash,role="execute"]
----
oc get csv -n openshift-adp | grep oadp
----

Check Velero is running:

[source,bash,role="execute"]
----
oc get pods -n openshift-adp -l app.kubernetes.io/name=velero
----

Check the backup storage location is available:

[source,bash,role="execute"]
----
oc get backupstoragelocations -n openshift-adp
----

You should see `Available` in the PHASE column. This means OADP can connect to the S3 storage and is ready to take backups.

== Deploy an Application

Let's deploy a sample application with configuration data and secrets — the kind of workload you'd protect in production:

[source,bash,role="execute"]
----
cat <<EOF | oc apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: backup-demo
  labels:
    app: backup-demo
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: backup-demo
data:
  message: "This is important configuration data that must survive disasters!"
  version: "1.0"
  environment: "production"
---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: backup-demo
type: Opaque
stringData:
  database-password: "super-secret-password"
  api-key: "abc123xyz789"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
  namespace: backup-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: web-app
  template:
    metadata:
      labels:
        app: web-app
    spec:
      containers:
      - name: httpd
        image: registry.access.redhat.com/ubi9/httpd-24
        ports:
        - containerPort: 8080
        envFrom:
        - configMapRef:
            name: app-config
---
apiVersion: v1
kind: Service
metadata:
  name: web-app
  namespace: backup-demo
spec:
  selector:
    app: web-app
  ports:
  - port: 80
    targetPort: 8080
EOF
----

Wait for pods to be running:

[source,bash,role="execute"]
----
oc get pods -n backup-demo -w
----

Press `Ctrl+C` when both pods show `Running`.

== Backup the Application

Create a backup of the entire `backup-demo` namespace:

[source,bash,role="execute"]
----
cat <<EOF | oc apply -f -
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: backup-demo-full
  namespace: openshift-adp
spec:
  includedNamespaces:
    - backup-demo
  ttl: 720h
EOF
----

Watch the backup complete:

[source,bash,role="execute"]
----
oc get backup backup-demo-full -n openshift-adp -w
----

Press `Ctrl+C` when STATUS shows `Completed`. This backs up every resource in the namespace — Deployments, Services, ConfigMaps, Secrets, everything.

== Simulate a Disaster

Delete the entire namespace:

[source,bash,role="execute"]
----
oc delete namespace backup-demo
----

Verify it's gone:

[source,bash,role="execute"]
----
oc get namespace backup-demo
----

----
Error from server (NotFound): namespaces "backup-demo" not found
----

**Everything is gone.** In production, this could be accidental deletion, ransomware, or infrastructure failure.

== Restore from Backup

Bring it all back:

[source,bash,role="execute"]
----
cat <<EOF | oc apply -f -
apiVersion: velero.io/v1
kind: Restore
metadata:
  name: restore-demo-full
  namespace: openshift-adp
spec:
  backupName: backup-demo-full
  includedNamespaces:
    - backup-demo
  restorePVs: true
EOF
----

Watch the restore:

[source,bash,role="execute"]
----
oc get restore restore-demo-full -n openshift-adp -w
----

Press `Ctrl+C` when `Completed`.

== Verify the Restore

Check everything is back:

[source,bash,role="execute"]
----
oc get pods -n backup-demo
----

Both pods should be `Running` again. Verify the configuration data survived:

[source,bash,role="execute"]
----
oc get configmap app-config -n backup-demo -o jsonpath='{.data.message}'
----

----
This is important configuration data that must survive disasters!
----

The application, its configuration, and its secrets are all restored exactly as they were.

== Schedule Regular Backups

For production, automate backups with a schedule:

[source,bash,role="execute"]
----
cat <<EOF | oc apply -f -
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: daily-backup
  namespace: openshift-adp
spec:
  schedule: "0 2 * * *"
  template:
    includedNamespaces:
      - backup-demo
    ttl: 168h
EOF
----

This runs a backup daily at 2:00 AM with 7-day retention. View the schedule:

[source,bash,role="execute"]
----
oc get schedules -n openshift-adp
----

== Summary

You backed up a running application, deleted it completely, and restored it in seconds. In production, this same workflow protects against:

* Accidental namespace deletion
* Failed upgrades or patches
* Ransomware or data corruption
* Infrastructure failure

**Key commands:**

[source,bash]
----
oc get backups -n openshift-adp          # List backups
oc get restores -n openshift-adp         # List restores
oc get schedules -n openshift-adp        # List schedules
oc get backupstoragelocations -n openshift-adp  # Check storage
----
